<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Room Furniture Planner</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f0f0f0;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .controls {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .control-group {
            margin-bottom: 15px;
        }

        label {
            display: inline-block;
            width: 150px;
        }

        input[type="number"] {
            width: 80px;
            padding: 5px;
        }

        input[type="text"] {
            width: 150px;
            padding: 5px;
        }

        button {
            padding: 8px 15px;
            margin: 5px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            background-color: #007bff;
            color: white;
        }

        button:hover {
            background-color: #0056b3;
        }

        button.danger {
            background-color: #dc3545;
        }

        button.danger:hover {
            background-color: #c82333;
        }

        #canvas-container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow: auto;
        }

        #room-canvas {
            border: 1px solid #ddd;
            cursor: move;
            display: block;
            margin: 0 auto;
        }

        .furniture-list {
            margin-top: 10px;
        }

        .furniture-item {
            display: inline-block;
            margin: 5px;
            padding: 5px 10px;
            background: #e9ecef;
            border-radius: 4px;
        }

        .furniture-item button {
            padding: 2px 5px;
            font-size: 12px;
            margin-left: 5px;
        }
    </style>
</head>
<body>
<div class="container">
    <h1>Room Furniture Planner</h1>

    <div class="controls">
        <h3>Room Dimensions</h3>
        <div class="control-group">
            <label>Width (cm):</label>
            <input type="number" id="room-width" value="500">
            <label>Length (cm):</label>
            <input type="number" id="room-length" value="400">
            <button onclick="updateRoom()">Update Room</button>
        </div>

        <h3>Add Furniture</h3>
        <div class="control-group">
            <label>Name:</label>
            <input type="text" id="furniture-name" placeholder="e.g. Sofa">
        </div>
        <div class="control-group">
            <label>Width (cm):</label>
            <input type="number" id="furniture-width" value="200">
            <label>Length (cm):</label>
            <input type="number" id="furniture-length" value="80">
        </div>
        <div class="control-group">
            <button onclick="addFurniture()">Add Furniture</button>
            <button onclick="downloadLayout()">Download Layout</button>
            <input type="file" id="upload-layout" style="display:none" accept=".json" onchange="uploadLayout(event)">
            <button onclick="document.getElementById('upload-layout').click()">Upload Layout</button>
            <button onclick="clearAll()" class="danger">Clear All</button>
        </div>

        <div class="furniture-list" id="furniture-list"></div>
    </div>

    <div id="canvas-container">
        <canvas id="room-canvas"></canvas>
    </div>

    <p style="margin-top: 10px; color: #666;">
        • Scale: 1 pixel = 1 cm
    </p>
</div>

<script>
    const canvas = document.getElementById('room-canvas');
    const ctx = canvas.getContext('2d');

    let roomWidth = 500;
    let roomLength = 400;
    let furniture = [];
    let selectedFurniture = null;
    let isDragging = false;
    let dragOffset = { x: 0, y: 0 };

    function keepFurnitureInBounds(f) {
        f.x = Math.max(f.width / 2, Math.min(roomWidth - f.width / 2, f.x));
        f.y = Math.max(f.length / 2, Math.min(roomLength - f.length / 2, f.y));
    }

    // Initialize
    function init() {
        loadLayout();
        updateRoom();
        updateFurnitureList();
        setupEventListeners();
    }

    function updateRoom() {
        roomWidth = parseInt(document.getElementById('room-width').value);
        roomLength = parseInt(document.getElementById('room-length').value);

        canvas.width = roomWidth;
        canvas.height = roomLength;

        draw();
        saveLayout(); // Auto-save after room update
    }

    function addFurniture() {
        const name = document.getElementById('furniture-name').value || 'Furniture';
        const width = parseInt(document.getElementById('furniture-width').value);
        const length = parseInt(document.getElementById('furniture-length').value);

        // x and y are the centre of the furniture item
        const newFurniture = {
            id: Date.now(),
            name: name,
            width: width,
            length: length,
            x: 150,
            y: 150,
            color: `hsl(${Math.random() * 360}, 70%, 70%)`
        };

        keepFurnitureInBounds(newFurniture);

        furniture.push(newFurniture);
        updateFurnitureList();
        draw();
        saveLayout(); // Auto-save after adding

        // Clear inputs
        document.getElementById('furniture-name').value = '';
    }

    function deleteFurniture(id) {
        furniture = furniture.filter(f => f.id !== id);
        updateFurnitureList();
        draw();
        saveLayout(); // Auto-save after deleting
    }

    function rotate(f) {
        // Swap dimensions when rotating
        const temp = f.width;
        f.width = f.length;
        f.length = temp;

        keepFurnitureInBounds(f);

        draw();
        saveLayout(); // Auto-save after rotating
    }

    function updateFurnitureList() {
        const list = document.getElementById('furniture-list');
        list.innerHTML = furniture.map(f => `
                <div class="furniture-item">
                    ${f.name} (${f.width}×${f.length})
                    <button onclick="deleteFurniture(${f.id})" class="danger">Delete</button>
                </div>
            `).join('');
    }

    function drawRotationIcon(icon) {
        ctx.font = `${2 * icon.size}px Arial`;
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillStyle = '#333';
        ctx.fillText('↺', icon.x, icon.y);
    }

    function draw() {
        // Clear canvas
        ctx.fillStyle = '#f8f9fa';
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        // Draw grid of dots every 10 pixels
        ctx.save();
        ctx.fillStyle = '#bbb';
        for (let x = 0; x < canvas.width; x += 10) {
            for (let y = 0; y < canvas.height; y += 10) {
                ctx.beginPath();
                ctx.arc(x, y, 1.2, 0, 2 * Math.PI);
                ctx.fill();
            }
        }
        ctx.restore();

        // Draw room outline
        ctx.strokeStyle = '#333';
        ctx.lineWidth = 2;
        ctx.strokeRect(1, 1, canvas.width - 2, canvas.height - 2);

        // Draw furniture
        furniture.forEach(f => {
            ctx.save();

            // Translate to furniture center
            ctx.translate(f.x, f.y);

            // Draw furniture rectangle
            ctx.fillStyle = f.color;
            ctx.fillRect(-f.width / 2, -f.length / 2, f.width, f.length);

            // Draw border
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 1;
            ctx.strokeRect(-f.width / 2, -f.length / 2, f.width, f.length);

            // Draw label
            ctx.fillStyle = '#000';
            ctx.font = '12px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(f.name, 0, 0);

            ctx.restore();

            f.rotationIcon = {
                x: f.x + -f.width / 2 + 8,
                y: f.y + -f.length / 2 + 8,
                size: 9
            };
            drawRotationIcon(f.rotationIcon);

        });
    }

    function isOnRotationIcon(f, x, y) {
        if (!f.rotationIcon) return false;
        const dx = x - f.rotationIcon.x;
        const dy = y - f.rotationIcon.y;
        return dx * dx + dy * dy <= f.rotationIcon.size * f.rotationIcon.size;
    }

    function getFurnitureAt(x, y) {
        for (let i = furniture.length - 1; i >= 0; i--) {
            const f = furniture[i];

            // Transform point to furniture's local coordinates
            const localX = x - f.x;
            const localY = y - f.y;

            if (Math.abs(localX) <= f.width / 2 && Math.abs(localY) <= f.length / 2) {
                return f;
            }
        }
        return null;
    }

    function setupEventListeners() {
        canvas.addEventListener('mousedown', (e) => {
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            selectedFurniture = getFurnitureAt(x, y);

            if (selectedFurniture) {
                if (isOnRotationIcon(selectedFurniture, x, y)) {
                    rotate(selectedFurniture);
                } else {
                    // Start dragging
                    isDragging = true;
                    dragOffset.x = x - selectedFurniture.x;
                    dragOffset.y = y - selectedFurniture.y;
                }
            }
        });

        canvas.addEventListener('mousemove', (e) => {
            if (isDragging && selectedFurniture) {
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;

                selectedFurniture.x = x - dragOffset.x;
                selectedFurniture.y = y - dragOffset.y;

                keepFurnitureInBounds(selectedFurniture);

                draw();
            }
        });

        canvas.addEventListener('mouseup', () => {
            isDragging = false;
            selectedFurniture = null;
            saveLayout();
        });

        canvas.addEventListener('contextmenu', (e) => {
            e.preventDefault();

            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            const f = getFurnitureAt(x, y);
            if (f) {
                rotate(f);
            }
        });
    }

    // Touch support for move and rotate
    let lastTouch = null;
    let touchStartFurniture = null;

    canvas.addEventListener('touchstart', (e) => {
        if (e.touches.length === 1) {
            const rect = canvas.getBoundingClientRect();
            const x = e.touches[0].clientX - rect.left;
            const y = e.touches[0].clientY - rect.top;
            let f = getFurnitureAt(x, y);
            if (f) {
                if (isOnRotationIcon(f, x, y)) {
                    rotate(f);
                } else {
                    // Start dragging
                    isDragging = true;
                    selectedFurniture = f;
                    touchStartFurniture = f;
                    dragOffset.x = x - selectedFurniture.x;
                    dragOffset.y = y - selectedFurniture.y;
                    lastTouch = { x, y };
                }
            }
        }
    });

    canvas.addEventListener('touchmove', (e) => {
        if (isDragging && selectedFurniture && e.touches.length === 1) {
            const rect = canvas.getBoundingClientRect();
            const x = e.touches[0].clientX - rect.left;
            const y = e.touches[0].clientY - rect.top;
            selectedFurniture.x = x - dragOffset.x;
            selectedFurniture.y = y - dragOffset.y;
            keepFurnitureInBounds(selectedFurniture);
            draw();
            lastTouch = { x, y };
            e.preventDefault();
        }
    });

    canvas.addEventListener('touchend', (e) => {
        isDragging = false;
        selectedFurniture = null;
        touchStartFurniture = null;
        saveLayout();
    });


    function saveLayout() {
        const data = {
            roomWidth,
            roomLength,
            furniture
        };
        localStorage.setItem('roomLayout', JSON.stringify(data));
    }

    function loadLayout() {
        const saved = localStorage.getItem('roomLayout');
        if (saved) {
            const data = JSON.parse(saved);
            roomWidth = data.roomWidth;
            roomLength = data.roomLength;
            furniture = data.furniture || [];

            document.getElementById('room-width').value = roomWidth;
            document.getElementById('room-length').value = roomLength;
        }
    }

    function clearAll() {
        if (confirm('Clear all furniture?')) {
            furniture = [];
            updateFurnitureList();
            draw();
            saveLayout();
        }
    }

    function downloadLayout() {
        const data = {
            roomWidth,
            roomLength,
            furniture
        };
        const blob = new Blob([JSON.stringify(data, null, 2)], {type: "application/json"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = "room-layout.json";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    function uploadLayout(event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = JSON.parse(e.target.result);
                roomWidth = data.roomWidth;
                roomLength = data.roomLength;
                furniture = data.furniture || [];
                document.getElementById('room-width').value = roomWidth;
                document.getElementById('room-length').value = roomLength;
                updateRoom();
                updateFurnitureList();
                saveLayout(); // Auto-save after upload
            } catch (err) {
                alert("Invalid layout file.");
            }
        };
        reader.readAsText(file);
    }

    // Initialize on load
    init();
</script>
</body>
</html>